<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Ibidem: Recreación Histórica</title>
    <meta name="description" content="Asociación de recreación histórica dedicada a la reconstrucción minuciosa de la vida civil romana.">
    
    <!-- Open Graph por defecto -->
    <meta property="og:site_name" content="Ibidem Recreación Histórica">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Ibidem: Recreación Histórica">
    <meta property="og:description" content="Asociación de recreación histórica dedicada a la reconstrucción minuciosa de la vida civil romana.">
    <meta property="og:image" content="https://raw.github.com/ibidemrecreacion/ibidemrecreacion.github.io/main/assets/img/General/Logos/svg/Ibidem_logo_nuevo_rojo.svg">

    <!-- Twitter Card por defecto -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ibidem: Recreación Histórica">
    <meta name="twitter:description" content="Asociación de recreación histórica dedicada a la reconstrucción minuciosa de la vida civil romana.">
    <meta name="twitter:image" content="https://raw.github.com/ibidemrecreacion/ibidemrecreacion.github.io/main/assets/img/General/Logos/svg/Ibidem_logo_nuevo_rojo.svg">

    <link rel="icon" type="image/svg+xml" href="https://raw.github.com/ibidemrecreacion/ibidemrecreacion.github.io/main/assets/img/General/Logos/svg/Ibidem_logo_nuevo_rojo.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">

    <style>
        /* Variables de color */
        :root {
            --color-pompeyano: #9A2A2A;
            --color-pergamino: #F5EFE3;
            --color-pizarra: #2A2A2A;
            --color-dorado: #B8860B;
            --color-dorado-safe: #856404;
        }

        body {
            font-family: 'Merriweather', serif;
            background-color: var(--color-pergamino);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            color: var(--color-pizarra);
            margin: 0;
            overflow-x: hidden;
        }

        /* Utilidades tipográficas */
        .font-cinzel { font-family: 'Cinzel', serif; }
        .font-merriweather { font-family: 'Merriweather', serif; }
        .text-reading { text-align: justify; line-height: 1.8; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.8s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Efecto Ken Burns para el Hero */
        .ken-burns { animation: kenBurns 20s ease-out infinite alternate; }
        @keyframes kenBurns {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* Loader */
        #loader { 
            position: fixed; inset: 0; background: var(--color-pergamino); 
            display: flex; justify-content: center; align-items: center; 
            z-index: 9999; flex-direction: column; transition: opacity 0.5s; 
        }
        .spinner { 
            width: 50px; height: 50px; border: 5px solid var(--color-dorado); 
            border-top: 5px solid var(--color-pompeyano); border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 20px; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Cabecera Sólida */
        .main-header {
            background-color: var(--color-pergamino); 
            border-bottom: 2px solid rgba(184, 134, 11, 0.3); 
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); 
        }

        .logo-white { filter: brightness(0) invert(1); }

        .timeline-line {
            position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background-color: #d1d5db;
        }
        @media (min-width: 768px) {
            .timeline-line { left: 50%; transform: translateX(-50%); }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--color-pergamino); }
        ::-webkit-scrollbar-thumb { background: var(--color-dorado); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-pompeyano); }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pompeyano: 'var(--color-pompeyano)',
                        pergamino: 'var(--color-pergamino)',
                        pizarra: 'var(--color-pizarra)',
                        dorado: 'var(--color-dorado)',
                        'dorado-safe': 'var(--color-dorado-safe)'
                    },
                    fontFamily: {
                        cinzel: ['Cinzel', 'serif'],
                        merriweather: ['Merriweather', 'serif'],
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="loader">
        <img src="https://raw.github.com/ibidemrecreacion/ibidemrecreacion.github.io/main/assets/img/General/Logos/svg/Ibidem_logo_nuevo_rojo.svg" alt="Ibidem Logo" class="h-24 w-auto mb-6 opacity-80" />
        <div class="spinner"></div>
        <p style="font-family: 'Cinzel', serif; color: var(--color-dorado-safe); letter-spacing: 2px;">CARGANDO HISTORIA...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const NAV_ITEMS = [
            { key: 'home', label: 'DOMUS' },
            { key: 'nostri', label: 'NOSTRI' },
            { key: 'fasti', label: 'FASTI' },
            { key: 'imagina', label: 'IMAGINA' },
            { key: 'tabularium', label: 'TABULARIUM' }
        ];

        // --- UTILIDADES ---
        const parseDate = (dateStr) => {
            if(!dateStr) return new Date(0);
            try {
                const months = {"enero": 0, "febrero": 1, "marzo": 2, "abril": 3, "mayo": 4, "junio": 5, "julio": 6, "agosto": 7, "septiembre": 8, "octubre": 9, "noviembre": 10, "diciembre": 11};
                const clean = dateStr.toLowerCase().replace(/de /g, '').replace(/,/g, '').split(' ');
                let m = -1, d = 1, y = new Date().getFullYear();
                clean.forEach(part => {
                    if (months[part] !== undefined) m = months[part];
                    else if (parseInt(part) > 31) y = parseInt(part);
                    else if (!isNaN(part)) d = parseInt(part);
                });
                return m === -1 ? new Date(0) : new Date(y, m, d);
            } catch (e) { return new Date(0); }
        };

        const parseMarkdown = (text) => {
            if (!text) return '';
            text = text.replace(/^\d+\.\s+(.+)$/gm, '<li class="ml-6">$1</li>');
            text = text.replace(/(<li class="ml-6">.*<\/li>\n?)+/g, '<ol class="list-decimal list-inside space-y-2 my-4">$&</ol>');
            text = text.replace(/^[-•]\s+(.+)$/gm, '<li class="ml-6">$1</li>');
            text = text.replace(/(<li class="ml-6">.*<\/li>\n?)+/g, '<ul class="list-disc list-inside space-y-2 my-4">$&</ul>');
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong class="font-bold text-pizarra">$1</strong>');
            text = text.replace(/\*(.+?)\*/g, '<em class="italic">$1</em>');
            text = text.replace(/__(.+?)__/g, '<u class="underline decoration-2 decoration-pompeyano">$1</u>');
            const paragraphs = text.split('\n\n').map(p => {
                if (p.trim().startsWith('<ol') || p.trim().startsWith('<ul')) {
                    return p;
                }
                return `<p class="mb-4">${p.replace(/\n/g, '<br/>')}</p>`;
            }).join('');
            return paragraphs;
        };

        // --- ICONOS SVG (AQUÍ ESTÁN TODOS) ---
        // Se usa fill="currentColor" o stroke="currentColor" para que tomen el color del texto (tailwind classes)
        const Icon = ({ path, size = 24, className = "", fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke={fill === "none" ? "currentColor" : "none"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={path} /></svg>
        );

        const Icons = {
            Menu: "M4 12h16M4 6h16M4 18h16", 
            X: "M18 6L6 18M6 6l12 12", 
            Mail: "M4 4h16c2 0 2 2 2 2v12c0 2-2 2-2 2H4c-2 0-2-2-2-2V6c0-2 2-2 2-2zM22 6l-10 7L2 6",
            ArrowLeft: "M19 12H5 M12 19l-7-7 7-7", 
            ChevronRight: "M9 18l6-6-6-6", 
            ChevronLeft: "M15 18l-6-6 6-6", 
            Camera: "M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 13a4 4 0 1 0 0-8 4 4 0 0 0 0 8",
            MapPin: "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6",
            ArrowUp: "M12 19V5M5 12l7-7 7 7",
            Link: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",
            // Redes Sociales
            Facebook: "M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z",
            Instagram: "M15 2h-6a7 7 0 0 0-7 7v6a7 7 0 0 0 7 7h6a7 7 0 0 0 7-7V9a7 7 0 0 0-7-7z M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M17.5 6.5h.01",
            BrandX: "M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z",
            BrandWhatsapp: "M3 21l1.65-3.8C3.37 15.6 3.37 12.4 4.65 10.1C5.9 7.8 8.1 6.3 10.6 6c2.5-.3 5.1.4 7.1 2.1c2 1.7 2.9 4.3 2.3 6.9c-.6 2.6-2.6 4.6-5.2 5.2c-2.6.6-5.2-.3-6.9-2.3L3 21z M9 10a.5.5 0 0 0 1 0V9a.5.5 0 0 0-1 0v1a5 5 0 0 0 5 5h1a.5.5 0 0 0 0-1h-1a.5.5 0 0 0 0 1"
        };

        // --- COMPONENTES UI ---

        const MobileStoryCard = ({ img, title, subtitle, category, link, children }) => (
            <a href={link} className="relative min-w-[85vw] h-full rounded-2xl overflow-hidden shadow-xl snap-center mx-2 border-2 border-dorado/50 group shrink-0 focus:ring-4 focus:ring-pompeyano focus:outline-none" aria-label={`Ver detalle de ${title}`}>
                <img src={img} alt={title} className="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x700/2A2A2A/F5EFE3?text=Sin+Imagen"; }}/>
                <div className="absolute inset-0 bg-gradient-to-t from-black/95 via-black/40 to-transparent"></div>
                <div className="absolute bottom-0 left-0 right-0 p-6 text-white flex flex-col justify-end h-full pointer-events-none">
                    {category && <span className="text-dorado text-xs font-bold tracking-widest uppercase mb-2 inline-block bg-black/80 px-2 py-1 rounded w-fit">{category}</span>}
                    <h3 className="font-cinzel text-xl font-bold mb-1 leading-tight drop-shadow-lg text-white">{title}</h3>
                    {subtitle && <p className="text-gray-300 text-sm italic mb-2">{subtitle}</p>}
                    <div className="mt-2 opacity-90">{children}</div>
                </div>
            </a>
        );

        const SectionHeader = ({ title, subtitle }) => (
            <div className="text-center mb-8 md:mb-16 fade-in pt-4 md:pt-8">
                {subtitle && <span className="block font-cinzel text-dorado-safe text-sm tracking-[0.3em] uppercase mb-2 md:mb-3 font-bold">{subtitle}</span>}
                <h2 className="font-cinzel text-3xl md:text-5xl font-bold text-pizarra leading-tight inline-block relative px-6 pb-2">
                    {title}
                    <span className="absolute bottom-0 left-1/2 -translate-x-1/2 w-24 h-1 bg-gradient-to-r from-transparent via-pompeyano to-transparent rounded"></span>
                </h2>
            </div>
        );

        const ScrollToTop = () => {
            const [visible, setVisible] = useState(false);
            useEffect(() => {
                const toggle = () => setVisible(window.pageYOffset > 300);
                window.addEventListener("scroll", toggle);
                return () => window.removeEventListener("scroll", toggle);
            }, []);
            return (
                <button onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })} className={`fixed bottom-20 md:bottom-6 right-6 p-4 bg-pompeyano text-white rounded-full shadow-lg z-30 transition-all focus:outline-none focus:ring-4 focus:ring-dorado ${visible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} aria-label="Volver arriba">
                    <Icon path={Icons.ArrowUp} size={24} />
                </button>
            );
        };

        const LegalModal = ({ type, onClose }) => {
            const title = type === 'legal' ? 'Aviso Legal' : 'Accesibilidad';
            const content = type === 'legal' ? (
                <>
                    <p className="mb-4 font-bold">Titularidad: Ibidem Recreación Histórica.</p>
                    <p className="mb-4">Contacto: ibidemrecreacion@gmail.com.</p>
                </>
            ) : (
                <ul className="list-disc list-inside space-y-2">
                    <li>Contraste de color mejorado según pautas WCAG.</li>
                    <li>Navegación clara y consistente.</li>
                    <li>Etiquetas ARIA para lectores de pantalla.</li>
                    <li>Tamaño de fuente legible y tipografía clara.</li>
                </ul>
            );
            return (
                <div className="fixed inset-0 bg-pizarra/90 z-50 flex items-center justify-center p-4" onClick={onClose} role="dialog" aria-modal="true">
                    <div className="bg-white rounded p-6 max-w-sm w-full border-t-8 border-pompeyano" onClick={e => e.stopPropagation()}>
                        <h3 className="font-bold text-xl mb-4 text-pizarra">{title}</h3>
                        <div className="text-sm text-gray-800">{content}</div>
                        <button onClick={onClose} className="mt-6 w-full py-3 bg-pompeyano text-white font-bold rounded hover:bg-red-800 transition focus:outline-none focus:ring-4 focus:ring-dorado">Cerrar</button>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE SOCIAL SHARE ---
        // Aquí es donde se dibujan los iconos usando la lista de arriba
        const SocialShare = ({ article }) => {
            const [copied, setCopied] = useState(false);
            
            const url = window.location.href;
            const title = article.title || "Ibidem Recreación";
            const shareText = `Te recomiendo leer "${title}" en IBIDEM Recreación:`;

            const shareLinks = {
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(url)}&via=IbidemRecre`,
                whatsapp: `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText + ' ' + url)}`
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(url).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                });
            };

            return (
                <div className="flex flex-col items-center my-8 border-t border-b border-dorado/30 py-6 bg-pergamino/40 rounded-lg">
                    <span className="font-cinzel text-xs font-bold text-dorado-safe tracking-widest uppercase mb-4">Compartir Artículo</span>
                    <div className="flex gap-8 items-center">
                        {/* Facebook */}
                        <a href={shareLinks.facebook} target="_blank" rel="noopener noreferrer" className="text-pizarra hover:text-[#1877F2] transition transform hover:scale-125" aria-label="Compartir en Facebook" title="Facebook">
                            <Icon path={Icons.Facebook} size={28} fill="currentColor" />
                        </a>
                        
                        {/* X (Twitter) */}
                        <a href={shareLinks.twitter} target="_blank" rel="noopener noreferrer" className="text-pizarra hover:text-black transition transform hover:scale-125" aria-label="Compartir en X" title="X (Twitter)">
                             <Icon path={Icons.BrandX} size={26} fill="currentColor" />
                        </a>
                        
                        {/* WhatsApp */}
                        <a href={shareLinks.whatsapp} target="_blank" rel="noopener noreferrer" className="text-pizarra hover:text-[#25D366] transition transform hover:scale-125" aria-label="Compartir en WhatsApp" title="WhatsApp">
                             <Icon path={Icons.BrandWhatsapp} size={28} />
                        </a>

                        {/* Instagram Link */}
                        <a href="https://www.instagram.com/ibidemrecreacion/" target="_blank" rel="noopener noreferrer" className="text-pizarra hover:text-[#C13584] transition transform hover:scale-125" aria-label="Síguenos en Instagram" title="Instagram">
                            <Icon path={Icons.Instagram} size={28} fill="currentColor" />
                        </a>

                        {/* Copiar Enlace */}
                        <button onClick={copyToClipboard} className="text-pizarra hover:text-pompeyano transition transform hover:scale-125 relative group" aria-label="Copiar enlace" title="Copiar enlace">
                            <Icon path={Icons.Link} size={26} />
                            {copied && <span className="absolute -top-10 left-1/2 -translate-x-1/2 bg-pompeyano text-white text-[10px] px-2 py-1 rounded shadow-lg animate-bounce whitespace-nowrap">¡Enlace Copiado!</span>}
                        </button>
                    </div>
                </div>
            );
        };

        // --- PÁGINAS ---

        const PageHome = ({ data }) => (
            <div className="fade-in">
                <section className="relative h-[55vh] md:h-[70vh] w-full rounded-xl overflow-hidden shadow-2xl mb-12 md:mb-16 bg-pizarra">
                    <div className="absolute inset-0 bg-cover bg-center ken-burns opacity-80" style={{ backgroundImage: `url(${data.general.heroImageHome})` }}></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-pizarra via-transparent to-transparent"></div>
                    <div className="absolute bottom-8 left-6 md:bottom-16 md:left-16 max-w-2xl z-10">
                        <div className="border-l-4 border-dorado pl-6 py-2 bg-black/60 backdrop-blur-sm rounded-r-lg">
                            <h1 className="font-merriweather text-xl md:text-3xl italic text-white leading-relaxed">{data.home.heroTitle}</h1>
                        </div>
                    </div>
                </section>
                <section className="max-w-4xl mx-auto text-center mb-16 px-6">
                    <p className="text-lg md:text-2xl text-pizarra leading-relaxed font-merriweather font-light">{data.home.intro}</p>
                    <div className="w-24 h-1 bg-dorado mx-auto mt-8 rounded-full"></div>
                </section>
                <SectionHeader title="FUNDAMENTA" subtitle="Nuestros Pilares" />
                
                <div className="hidden md:grid md:grid-cols-3 gap-8 mb-16 px-4">
                    {data.home.pilares.map((pilar, index) => (
                        <article key={index} className="bg-white p-8 rounded-lg shadow-lg border-t-4 border-dorado hover:-translate-y-2 transition-all">
                            <div className="w-12 h-12 bg-pergamino rounded-full flex items-center justify-center mb-4 border border-dorado">
                                <span className="font-cinzel font-bold text-pompeyano text-xl">{index + 1}</span>
                            </div>
                            <h3 className="font-cinzel text-xl font-bold text-pompeyano mb-3">{pilar.title}</h3>
                            <p className="text-gray-800 mb-6 text-sm leading-relaxed">{pilar.text}</p>
                        </article>
                    ))}
                </div>

                <div className="md:hidden flex overflow-x-auto snap-x snap-mandatory h-[55vh] items-center px-4 gap-4 pb-4 hide-scrollbar">
                    {data.home.pilares.map((pilar, i) => (
                        <div key={i} className="min-w-[85vw] h-full bg-white p-6 rounded-2xl shadow-xl border-t-8 border-dorado snap-center flex flex-col justify-center relative overflow-hidden border-b border-l border-r border-gray-200">
                            <div className="absolute top-0 right-0 text-[10rem] font-cinzel font-bold text-gray-100 -mr-10 -mt-10 z-0 select-none" aria-hidden="true">{i+1}</div>
                            <h3 className="font-cinzel text-2xl font-bold text-pompeyano mb-4 relative z-10">{pilar.title}</h3>
                            <p className="text-gray-800 text-lg leading-relaxed relative z-10 font-medium">{pilar.text}</p>
                            <div className="mt-6 relative z-10">
                                <a href={`#${pilar.linkTo}`} className="inline-block px-6 py-3 bg-pizarra text-white font-cinzel rounded-full text-sm font-bold shadow-lg active:scale-95 transition">Saber Más</a>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const PageNostri = ({ data }) => (
            <div className="fade-in px-4">
                <SectionHeader title="NOSTRI" subtitle="Nuestra Historia" />
                <div className="max-w-4xl mx-auto space-y-12">
                    <article className="bg-white p-8 md:p-12 rounded-lg shadow-xl border-l-4 border-pompeyano">
                        {data.nostri.mainText.split('\n').map((p, i) => (p.trim() && <p key={i} className="text-lg text-reading mb-4 text-gray-800">{p}</p>))}
                    </article>
                    <article className="bg-white p-6 rounded-xl shadow-xl flex flex-col md:flex-row gap-6 items-center border border-gray-100">
                        <img src={data.nostri.founder.image} alt={`Foto de ${data.nostri.founder.name}`} className="w-32 h-32 rounded-full border-4 border-dorado object-cover" />
                        <div className="text-center md:text-left">
                            <h4 className="font-cinzel text-2xl font-bold text-pizarra">{data.nostri.founder.name}</h4>
                            <span className="bg-pompeyano text-white text-xs px-3 py-1 rounded-full font-cinzel font-bold tracking-wider inline-block mt-2">FUNDADOR</span>
                            <p className="text-gray-700 italic mt-3 text-sm">{data.nostri.founder.desc}</p>
                        </div>
                    </article>
                </div>
            </div>
        );

        const PageFasti = ({ data }) => {
            const enrichedEvents = useMemo(() => {
                const all = [...(data.fasti.upcoming || []), ...(data.fasti.past || [])];
                return all.map(evt => {
                    const album = data.imagina ? data.imagina.find(a => a.id === evt.id) : null;
                    let img = evt.coverImage;
                    if (!img && album) img = album.coverImage || (album.images?.[0]?.src);
                    return { ...evt, displayImage: img };
                });
            }, [data]);

            const { future, past } = useMemo(() => {
                const now = new Date(); now.setHours(0,0,0,0);
                const future = [], past = [];
                enrichedEvents.forEach(e => {
                    const d = parseDate(e.date);
                    if(d >= now) future.push(e); else past.push(e);
                });
                future.sort((a,b) => parseDate(a.date) - parseDate(b.date));
                past.sort((a,b) => parseDate(b.date) - parseDate(a.date));
                return { future, past };
            }, [enrichedEvents]);

            const EventCardDesktop = ({ event, isFuture }) => (
                <a href={`#imagina?id=${event.id}`} className={`block bg-white rounded-lg overflow-hidden shadow-md hover:shadow-2xl transition-all group h-full flex flex-col ${isFuture ? 'border-t-4 border-pompeyano' : 'border-l-4 border-dorado'}`}>
                    <div className="h-48 overflow-hidden relative bg-gray-200">
                        {event.displayImage ? (
                            <img src={event.displayImage} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt="" />
                        ) : (
                            <div className="w-full h-full flex items-center justify-center text-gray-400 bg-gray-200"><Icon path={Icons.Camera} size={32}/></div>
                        )}
                    </div>
                    <div className="p-5 flex-grow">
                        <div className="text-xs font-bold uppercase text-gray-600 mb-2">{event.date}</div>
                        <h3 className="font-cinzel text-xl font-bold text-pizarra mb-2 group-hover:text-pompeyano decoration-pompeyano group-hover:underline underline-offset-4 decoration-2">{event.title}</h3>
                        <p className="text-gray-700 text-sm line-clamp-3">{event.desc}</p>
                    </div>
                </a>
            );

            return (
                <div className="fade-in pb-12">
                    <SectionHeader title="FASTI" subtitle="Calendario" />
                    <div className="md:hidden mb-8">
                         <div className="flex overflow-x-auto snap-x snap-mandatory h-[55vh] items-center px-4 gap-4 hide-scrollbar">
                            {future.map(e => (
                                <MobileStoryCard key={e.id} img={e.displayImage} title={e.title} subtitle={e.date} category="PRÓXIMO" link={`#imagina?id=${e.id}`}>
                                    <p className="text-xs text-gray-200 line-clamp-2">{e.location.locality}</p>
                                </MobileStoryCard>
                            ))}
                            {past.map(e => (
                                <MobileStoryCard key={e.id} img={e.displayImage} title={e.title} subtitle={e.date} category="PASADO" link={`#imagina?id=${e.id}`}>
                                     <p className="text-xs text-gray-200 line-clamp-2">{e.desc}</p>
                                </MobileStoryCard>
                            ))}
                         </div>
                         <p className="text-center text-sm font-bold text-pompeyano mt-4 animate-pulse" aria-hidden="true">← Desliza para ver más eventos →</p>
                    </div>

                    <div className="hidden md:block max-w-6xl mx-auto px-4">
                        <h3 className="font-cinzel text-2xl font-bold text-pompeyano mb-8 border-b border-pompeyano/20 pb-2">Proxima Eventa</h3>
                        <div className="grid md:grid-cols-3 gap-8 mb-16">
                            {future.map(e => <EventCardDesktop key={e.id} event={e} isFuture={true} />)}
                        </div>
                        <div className="timeline-line"></div>
                        <h3 className="font-cinzel text-2xl font-bold text-pizarra mb-8 border-b border-gray-200 pb-2">Acta Praeterita</h3>
                        <div className="space-y-12">
                            {past.map((evt, idx) => (
                                <div key={evt.id} className={`flex items-center justify-between w-full ${idx % 2 === 0 ? 'flex-row-reverse' : ''}`}>
                                    <div className="w-5/12"></div>
                                    <div className="w-5/12 relative"><EventCardDesktop event={evt} isFuture={false} /></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const PageTabularium = ({ data }) => {
            const [filter, setFilter] = useState('TODOS');
            const cats = ['TODOS', ...new Set(data.tabularium.map(a => a.category))];
            const filtered = data.tabularium.filter(a => filter === 'TODOS' || a.category === filter);

            return (
                <div className="fade-in">
                    <SectionHeader title="TABULARIUM" subtitle="Archivo" />
                    <div className="flex justify-center flex-wrap gap-2 mb-6 px-4">
                        {cats.map(c => (
                            <button key={c} onClick={() => setFilter(c)} className={`px-4 py-2 rounded-full font-cinzel text-[10px] font-bold tracking-wider border transition-all focus:outline-none focus:ring-2 focus:ring-pompeyano ${filter===c ? 'bg-pompeyano text-white border-pompeyano shadow-md' : 'bg-white text-pizarra border-gray-300 hover:border-pompeyano'}`}>
                                {c.toUpperCase()}
                            </button>
                        ))}
                    </div>

                    <div className="md:hidden flex overflow-x-auto snap-x snap-mandatory h-[55vh] items-center px-4 gap-4 hide-scrollbar">
                        {filtered.map(art => (
                            <MobileStoryCard key={art.id} img={art.img} title={art.title} subtitle={art.author} category={art.category} link={`#article?id=${art.id}`}>
                                <div className="flex items-center text-xs text-dorado mt-2 font-bold uppercase tracking-widest bg-black/60 px-2 py-1 rounded w-fit">
                                    Leer Artículo <Icon path={Icons.ArrowLeft} className="ml-1 rotate-180" size={12}/>
                                </div>
                            </MobileStoryCard>
                        ))}
                    </div>

                    <div className="hidden md:grid md:grid-cols-2 gap-10 max-w-6xl mx-auto px-4">
                        {filtered.map(art => (
                            <article key={art.id} className="bg-white rounded-xl shadow-lg overflow-hidden flex flex-col group border border-gray-200 hover:shadow-2xl transition-all">
                                <div className="h-56 overflow-hidden relative">
                                    <img src={art.img} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt="" />
                                    <span className="absolute top-4 left-4 bg-white text-pompeyano px-3 py-1 text-xs font-bold rounded font-cinzel shadow-sm border border-gray-100">{art.category}</span>
                                </div>
                                <div className="p-8 flex-col flex flex-grow">
                                    <h3 className="font-cinzel text-2xl font-bold text-pizarra mb-3 group-hover:text-pompeyano group-hover:underline">{art.title}</h3>
                                    <p className="text-gray-700 text-sm mb-6 line-clamp-3 flex-grow">{art.summary}</p>
                                    <a href={`#article?id=${art.id}`} className="text-pompeyano font-bold text-sm uppercase flex items-center hover:bg-gray-100 p-2 rounded -ml-2 w-fit">Leer Artículo <Icon path={Icons.ArrowLeft} className="ml-2 rotate-180" size={16}/></a>
                                </div>
                            </article>
                        ))}
                    </div>
                </div>
            );
        };

        const PageArticle = ({ id, data }) => {
            const art = data.tabularium.find(a => a.id == id);
            if (!art) return <div className="text-center py-20 text-xl font-bold text-pompeyano font-cinzel">Artículo no encontrado</div>;
            
            // Efecto para actualizar metadatos del navegador
            useEffect(() => {
                window.scrollTo(0,0);
                
                // 1. Título de la pestaña
                document.title = `${art.title} | Ibidem Tabularium`;
                
                // 2. Función auxiliar para actualizar meta tags
                const updateMeta = (selector, attribute, content) => {
                    let element = document.querySelector(selector);
                    if (!element) {
                        element = document.createElement('meta');
                        if(selector.includes('property')) element.setAttribute('property', selector.split('=')[1].replace(/"/g, ''));
                        if(selector.includes('name')) element.setAttribute('name', selector.split('=')[1].replace(/"/g, ''));
                        document.head.appendChild(element);
                    }
                    element.setAttribute(attribute, content);
                };

                updateMeta('meta[property="og:title"]', 'content', art.title);
                updateMeta('meta[property="og:description"]', 'content', art.summary);
                updateMeta('meta[property="og:image"]', 'content', art.img);
                updateMeta('meta[property="og:url"]', 'content', window.location.href);
                updateMeta('meta[name="twitter:title"]', 'content', art.title);
                updateMeta('meta[name="twitter:description"]', 'content', art.summary);
                updateMeta('meta[name="twitter:image"]', 'content', art.img);

            }, [id, art]);

            const renderContent = (content) => {
                return <div dangerouslySetInnerHTML={{ __html: parseMarkdown(content) }} />;
            };

            const renderImage = (img) => {
                if (!img) return null;
                return (
                    <figure className="my-6 md:float-right md:w-5/12 md:ml-8 md:mb-4 md:mt-1 clear-right">
                        <img src={img.src} className="w-full rounded-lg shadow-lg" alt={img.caption || ''} />
                        {img.caption && (
                            <figcaption className="text-sm text-gray-600 italic text-center mt-2 px-4">
                                {img.caption}
                            </figcaption>
                        )}
                    </figure>
                );
            };

            return (
                <article className="max-w-4xl mx-auto bg-white p-6 md:p-16 rounded-xl shadow-2xl my-4 md:my-8 fade-in relative border border-gray-200">
                    <a href="#tabularium" className="inline-flex items-center text-gray-600 hover:text-pompeyano transition mb-6 font-bold text-sm bg-gray-100 px-4 py-2 rounded-full hover:bg-gray-200">
                        <Icon path={Icons.ArrowLeft} size={16} className="mr-2"/> Volver
                    </a>
                    
                    <header className="mb-6 border-b border-gray-200 pb-6">
                        {art.antetitle && <span className="text-xs font-cinzel text-dorado-safe uppercase tracking-[0.3em] block mb-3 font-bold">{art.antetitle}</span>}
                        <span className="text-xs font-cinzel text-gray-500 uppercase tracking-[0.2em] block mb-2">{art.category}</span>
                        <h1 className="font-cinzel text-3xl md:text-5xl font-bold text-pizarra mb-4 leading-tight">{art.title}</h1>
                        <p className="text-sm text-gray-600 italic">Por {art.author} • {art.date}</p>
                    </header>

                    {/* BARRA DE COMPARTIR SUPERIOR */}
                    <SocialShare article={art} />

                    <img src={art.img} className="w-full h-64 md:h-96 object-cover rounded-lg shadow-lg mb-8" alt={`Imagen principal de ${art.title}`} />

                    <div className="prose max-w-none text-gray-900 text-reading">
                        <div className="text-lg border-l-4 border-pompeyano pl-6 mb-10 text-gray-800 bg-gray-50 p-6 rounded-r-lg leading-relaxed">
                            {renderContent(art.intro)}
                        </div>

                        {art.sections.map((section, i) => (
                            <section key={i} className="mb-12 flow-root">
                                <h2 className="font-cinzel text-2xl md:text-3xl font-bold text-pompeyano mb-6 mt-8 pb-2 border-b-2 border-pompeyano/30">{section.title}</h2>
                                {section.image && !section.subsections && renderImage(section.image)}
                                {section.content && <div className="mb-6 text-lg leading-relaxed">{renderContent(section.content)}</div>}
                                {section.subsections && section.subsections.map((subsection, j) => (
                                    <div key={j} className="mb-8 ml-0 md:ml-4 flow-root">
                                        <h3 className="font-cinzel text-xl md:text-2xl font-bold text-pizarra mb-4 mt-6">{subsection.subtitle}</h3>
                                        {subsection.image && renderImage(subsection.image)}
                                        <div className="text-lg leading-relaxed">{renderContent(subsection.content)}</div>
                                    </div>
                                ))}
                            </section>
                        ))}

                        {art.bibliography && art.bibliography.length > 0 && (
                            <section className="mt-16 pt-8 border-t-2 border-gray-300 clear-both">
                                <h2 className="font-cinzel text-2xl font-bold text-pizarra mb-6 flex items-center">
                                    <span className="w-2 h-8 bg-pompeyano mr-3 rounded"></span> Bibliografía
                                </h2>
                                <div className="bg-gray-50 p-6 rounded-lg">
                                    <ul className="space-y-3">
                                        {art.bibliography.map((ref, idx) => (
                                            <li key={idx} className="text-sm text-gray-800 leading-relaxed pl-4 border-l-2 border-dorado">
                                                {typeof ref === 'string' ? ref : <><span className="font-bold uppercase">{ref.author}</span>. <em>{ref.title}</em>. {ref.publisher}{ref.year && `, ${ref.year}`}{ref.pages && `, pp. ${ref.pages}`}.</>}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </section>
                        )}
                    </div>
                    
                    {/* BARRA DE COMPARTIR INFERIOR */}
                    <SocialShare article={art} />
                </article>
            );
        };

        const PageImagina = ({ albumId, data }) => {
            const [selected, setSelected] = useState(null);

            const albums = useMemo(() => {
                const combined = [...(data.imagina || [])];
                const events = [...(data.fasti.upcoming||[]), ...(data.fasti.past||[])];
                events.forEach(e => {
                    if (!combined.find(a => a.id === e.id) && (e.images || e.coverImage)) {
                        const imgs = e.images ? [...e.images] : [];
                        if (e.coverImage && (!imgs[0] || imgs[0].src !== e.coverImage)) imgs.unshift({src: e.coverImage});
                        if (imgs.length > 0) combined.push({ id: e.id, eventTitle: e.title, date: e.date, coverImage: e.coverImage || imgs[0].src, images: imgs });
                    }
                });
                return combined.sort((a,b) => parseDate(b.date) - parseDate(a.date));
            }, [data]);

            const currentAlbum = albumId ? albums.find(a => a.id == albumId) : null;

            if (currentAlbum) {
                return (
                    <div className="fade-in max-w-6xl mx-auto px-4">
                        <div className="mb-8">
                             <a href="#imagina" className="inline-flex items-center text-gray-600 hover:text-pompeyano transition mb-4 font-bold text-sm bg-white px-4 py-2 rounded-full shadow hover:shadow-lg">
                                <Icon path={Icons.ArrowLeft} size={16} className="mr-2"/> Volver a Galería
                            </a>
                            <h2 className="font-cinzel text-3xl font-bold text-pompeyano mb-2">{currentAlbum.eventTitle}</h2>
                            <p className="text-gray-600 mb-6">{currentAlbum.date} - {currentAlbum.location?.locality}</p>
                            
                            <div className="columns-1 md:columns-2 lg:columns-3 gap-4 space-y-4">
                                {currentAlbum.images.map((img, idx) => (
                                    <div key={idx} className="break-inside-avoid relative group cursor-zoom-in overflow-hidden rounded-lg shadow-lg bg-white" onClick={() => setSelected(img)}>
                                        <img src={img.src} alt={img.caption} className="w-full h-auto transform transition-transform duration-500 group-hover:scale-110" loading="lazy" />
                                        {img.caption && (
                                            <div className="absolute bottom-0 left-0 right-0 bg-black/70 p-2 text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                                                {img.caption}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                        {selected && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/95 p-4" onClick={() => setSelected(null)}>
                                <button className="absolute top-4 right-4 text-white hover:text-dorado"><Icon path={Icons.X} size={40}/></button>
                                <img src={selected.src} className="max-w-full max-h-[90vh] rounded shadow-2xl border-4 border-pizarra" alt={selected.caption} onClick={e => e.stopPropagation()} />
                                {selected.caption && <p className="absolute bottom-8 text-white bg-black/50 px-4 py-2 rounded font-cinzel">{selected.caption}</p>}
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className="fade-in px-4">
                    <SectionHeader title="IMAGINA" subtitle="Galería Fotográfica" />
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
                        {albums.map(album => (
                            <a key={album.id} href={`#imagina?id=${album.id}`} className="block group relative aspect-[4/3] overflow-hidden rounded-xl shadow-lg cursor-pointer">
                                <img src={album.coverImage} alt={album.eventTitle} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 filter brightness-75 group-hover:brightness-100" />
                                <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-90"></div>
                                <div className="absolute bottom-0 left-0 p-6 w-full">
                                    <h3 className="text-white font-cinzel text-xl font-bold mb-1 leading-tight group-hover:text-dorado transition-colors">{album.eventTitle}</h3>
                                    <p className="text-gray-300 text-xs uppercase tracking-wider">{album.date}</p>
                                    <div className="flex items-center text-white/80 text-xs mt-3 font-bold">
                                        <Icon path={Icons.Camera} size={14} className="mr-2"/> {album.images?.length || 0} Fotos
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('home');
            const [params, setParams] = useState({});
            const [data, setData] = useState(null);
            const [menuOpen, setMenuOpen] = useState(false);
            const [scrolled, setScrolled] = useState(false);
            const [showLegal, setShowLegal] = useState(null);

            useEffect(() => {
                fetch('datos.json')
                    .then(r => r.json())
                    .then(d => {
                        setData(d);
                        document.getElementById('loader').style.opacity = '0';
                        setTimeout(() => document.getElementById('loader').remove(), 500);
                    })
                    .catch(e => console.error(e));
                
                const handleHash = () => {
                    const hash = window.location.hash.substring(1) || 'home';
                    if (hash.includes('?')) {
                        const [p, q] = hash.split('?');
                        const urlParams = new URLSearchParams(q);
                        setPage(p);
                        setParams(Object.fromEntries(urlParams.entries()));
                    } else {
                        setPage(hash);
                        setParams({});
                    }
                    window.scrollTo(0,0);
                    setMenuOpen(false);
                };
                
                window.addEventListener('hashchange', handleHash);
                handleHash();

                const onScroll = () => setScrolled(window.scrollY > 50);
                window.addEventListener('scroll', onScroll);

                return () => {
                    window.removeEventListener('hashchange', handleHash);
                    window.removeEventListener('scroll', onScroll);
                };
            }, []);

            if (!data) return null;

            const renderPage = () => {
                switch(page) {
                    case 'home': return <PageHome data={data} />;
                    case 'nostri': return <PageNostri data={data} />;
                    case 'fasti': return <PageFasti data={data} />;
                    case 'imagina': return <PageImagina albumId={params.id} data={data} />;
                    case 'tabularium': return <PageTabularium data={data} />;
                    case 'article': return <PageArticle id={params.id} data={data} />;
                    default: return <PageHome data={data} />;
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className={`fixed w-full z-50 transition-all duration-300 ${scrolled ? 'py-2 main-header' : 'py-4 bg-transparent'}`}>
                        <div className="max-w-7xl mx-auto px-4 flex justify-between items-center">
                            <a href="#home" className="flex items-center gap-3 group">
                                <img src={data.general.logoUrl} alt="Ibidem" className={`transition-all duration-300 ${scrolled ? 'h-10' : 'h-14 md:h-16'}`} />
                                <div className={`flex flex-col ${scrolled ? 'opacity-100' : 'opacity-0 md:opacity-100'} transition-opacity`}>
                                    <span className={`font-cinzel font-bold text-xl leading-none ${scrolled ? 'text-pompeyano' : 'text-pompeyano md:text-white md:drop-shadow-md'}`}>IBIDEM</span>
                                    <span className={`text-[0.65rem] tracking-[0.3em] uppercase ${scrolled ? 'text-pizarra' : 'text-gray-600 md:text-gray-200'}`}>Recreación Histórica</span>
                                </div>
                            </a>
                            
                            <nav className="hidden md:flex gap-8">
                                {NAV_ITEMS.map(item => (
                                    <a key={item.key} href={`#${item.key}`} className={`font-cinzel text-sm font-bold tracking-widest relative py-2 transition-colors ${page===item.key ? 'text-pompeyano' : (scrolled ? 'text-pizarra hover:text-pompeyano' : 'text-white hover:text-dorado drop-shadow-md')}`}>
                                        {item.label}
                                        <span className={`absolute bottom-0 left-0 w-full h-0.5 bg-pompeyano transform origin-left transition-transform duration-300 ${page===item.key ? 'scale-x-100' : 'scale-x-0'}`}></span>
                                    </a>
                                ))}
                            </nav>

                            <button onClick={() => setMenuOpen(!menuOpen)} className={`md:hidden p-2 rounded focus:outline-none ${scrolled ? 'text-pizarra' : 'text-white bg-black/20'}`} aria-label="Menú">
                                <Icon path={menuOpen ? Icons.X : Icons.Menu} size={28} />
                            </button>
                        </div>
                    </header>

                    {/* Menú Móvil */}
                    <div className={`fixed inset-0 z-40 bg-pergamino/95 backdrop-blur-md transform transition-transform duration-300 md:hidden flex flex-col items-center justify-center space-y-8 ${menuOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                        {NAV_ITEMS.map(item => (
                            <a key={item.key} href={`#${item.key}`} onClick={() => setMenuOpen(false)} className={`font-cinzel text-2xl font-bold ${page===item.key ? 'text-pompeyano' : 'text-pizarra'}`}>{item.label}</a>
                        ))}
                    </div>

                    <main className="flex-grow pt-24 pb-12 w-full overflow-hidden">
                        {renderPage()}
                    </main>

                    <footer className="bg-pizarra text-pergamino pt-16 pb-8 border-t-8 border-dorado">
                        <div className="max-w-6xl mx-auto px-6 grid md:grid-cols-3 gap-12 mb-12 text-center md:text-left">
                            <div>
                                <img src={data.general.logoUrl} alt="Ibidem" className="h-16 mx-auto md:mx-0 mb-6 logo-white opacity-80" />
                                <p className="text-sm text-gray-400 leading-relaxed max-w-xs mx-auto md:mx-0">
                                    Reconstruyendo el pasado con rigor y pasión. Miembros de la comunidad internacional de recreación histórica.
                                </p>
                            </div>
                            <div className="flex flex-col items-center md:items-start">
                                <h4 className="font-cinzel text-dorado font-bold mb-6 text-lg">Contacto</h4>
                                <a href={`mailto:${data.general.email}`} className="flex items-center gap-3 text-gray-300 hover:text-white transition mb-2">
                                    <Icon path={Icons.Mail} size={18}/> {data.general.email}
                                </a>
                                <div className="flex gap-4 mt-4">
                                    <a href={data.general.facebook} target="_blank" className="p-2 bg-white/10 rounded-full hover:bg-pompeyano transition"><Icon path={Icons.Facebook} size={20} fill="currentColor"/></a>
                                    <a href={data.general.instagram} target="_blank" className="p-2 bg-white/10 rounded-full hover:bg-pompeyano transition"><Icon path={Icons.Instagram} size={20} fill="currentColor"/></a>
                                </div>
                            </div>
                            <div className="flex flex-col items-center md:items-start">
                                <h4 className="font-cinzel text-dorado font-bold mb-6 text-lg">Legal</h4>
                                <button onClick={() => setShowLegal('legal')} className="text-gray-400 hover:text-dorado text-sm mb-2 transition">Aviso Legal</button>
                                <button onClick={() => setShowLegal('access')} className="text-gray-400 hover:text-dorado text-sm transition">Accesibilidad</button>
                                <p className="text-gray-600 text-xs mt-8">© {new Date().getFullYear()} Ibidem Recreación.</p>
                            </div>
                        </div>
                    </footer>
                    
                    <ScrollToTop />
                    {showLegal && <LegalModal type={showLegal} onClose={() => setShowLegal(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


