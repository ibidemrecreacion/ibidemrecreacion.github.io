<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 1. IDENTIDAD Y SEO -->
    <title>Ibidem: Recreación Histórica</title>
    <meta name="description" content="Asociación de recreación histórica dedicada a la reconstrucción minuciosa de la vida civil romana, indumentaria y ritos en Andalucía.">
    
    <!-- Favicon SVG -->
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/ibidemrecreacion/ibidem/main/assets/img/General/Logos/svg/Ibidem_logo_nuevo_rojo.jpg">

    <!-- LIBRERÍAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">

    <style>
        /* Variables originales mantenidas */
        :root {
            --color-pompeyano: #9A2A2A;
            --color-pergamino: #F5EFE3;
            --color-pizarra: #2A2A2A;
            --color-dorado: #B8860B;
            --color-dorado-safe: #856404;
        }
        body {
            font-family: 'Merriweather', serif;
            background-color: var(--color-pergamino);
            /* Patrón de textura original */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3Cfilter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            color: var(--color-pizarra);
            margin: 0;
            overflow-x: hidden;
        }
        
        .font-cinzel { font-family: 'Cinzel', serif; }
        .font-merriweather { font-family: 'Merriweather', serif; }
        .text-reading { text-align: justify; line-height: 1.8; }
        .biblio-item { padding-left: 1.5rem; text-indent: -1.5rem; margin-bottom: 0.5rem; text-align: left; }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader & Spinner */
        #loader { 
            position: fixed; 
            inset: 0; 
            background: var(--color-pergamino); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            flex-direction: column; 
            transition: opacity 0.5s; 
        }
        .spinner { 
            width: 50px; 
            height: 50px; 
            border: 5px solid var(--color-dorado); 
            border-top: 5px solid var(--color-pompeyano); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin-bottom: 20px; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* HEADER & NAVIGATION */
        .main-header {
            background-color: rgba(245, 239, 227, 0.95); /* Pergamino semitransparente */
            backdrop-filter: blur(5px);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        
        /* Clase especial para invertir el color del logo a blanco */
        .logo-white { filter: brightness(0) invert(1); }

        /* TIMELINE VERTICAL */
        .timeline-line {
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #d1d5db; /* gray-300 */
        }
        @media (min-width: 768px) {
            .timeline-line { left: 50%; transform: translateX(-50%); }
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pompeyano: 'var(--color-pompeyano)',
                        pergamino: 'var(--color-pergamino)',
                        pizarra: 'var(--color-pizarra)',
                        dorado: 'var(--color-dorado)',
                        'dorado-safe': 'var(--color-dorado-safe)'
                    }
                }
            }
        }
    </script>
</head>
<body>
    <!-- LOADER -->
    <div id="loader">
        <img src="https://raw.githubusercontent.com/ibidemrecreacion/ibidem/main/assets/img/General/Logos/svg/Ibidem_logo_nuevo_rojo.svg" alt="Ibidem Logo" class="h-24 w-auto mb-6 opacity-80" />
        <div class="spinner"></div>
        <p style="font-family: 'Cinzel', serif; color: var(--color-dorado-safe);">CARGANDO HISTORIA...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- UTILIDADES ---
        const parseDate = (dateStr) => {
            if(!dateStr) return new Date(0);
            try {
                const months = {"enero": 0, "febrero": 1, "marzo": 2, "abril": 3, "mayo": 4, "junio": 5, "julio": 6, "agosto": 7, "septiembre": 8, "octubre": 9, "noviembre": 10, "diciembre": 11};
                const clean = dateStr.toLowerCase().replace(/de /g, '').replace(/,/g, '').split(' ');
                let m = -1, d = 1, y = new Date().getFullYear();
                clean.forEach(part => {
                    if (months[part] !== undefined) m = months[part];
                    else if (parseInt(part) > 31) y = parseInt(part);
                    else if (!isNaN(part)) d = parseInt(part);
                });
                return m === -1 ? new Date(0) : new Date(y, m, d);
            } catch (e) { return new Date(0); }
        };

        // --- ICONOS SVG ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={path} /></svg>
        );
        const Icons = {
            Menu: "M4 12h16M4 6h16M4 18h16", X: "M18 6L6 18M6 6l12 12", 
            Mail: "M4 4h16c2 0 2 2 2 2v12c0 2-2 2-2 2H4c-2 0-2-2-2-2V6c0-2 2-2 2-2zM22 6l-10 7L2 6",
            ArrowLeft: "M19 12H5 M12 19l-7-7 7-7", ChevronRight: "M9 18l6-6-6-6", ChevronLeft: "M15 18l-6-6 6-6", 
            Camera: "M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z M12 13a4 4 0 1 0 0-8 4 4 0 0 0 0 8",
            MapPin: "M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z M12 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6",
            Calendar: "M19 4h-1V3a1 1 0 0 0-2 0v1H8V3a1 1 0 0 0-2 0v1H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 16H5V9h14v11z",
            Facebook: "M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z",
            Instagram: "M15 2h-6a7 7 0 0 0-7 7v6a7 7 0 0 0 7 7h6a7 7 0 0 0 7-7V9a7 7 0 0 0-7-7z M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z M17.5 6.5h.01",
        };

        // --- COMPONENTES UI MEJORADOS ---
        
        const SectionHeader = ({ title, subtitle }) => (
            <div className="text-center mb-12 md:mb-16 fade-in pt-8">
                {subtitle && <span className="block font-cinzel text-dorado-safe text-sm tracking-[0.3em] uppercase mb-3 font-bold">{subtitle}</span>}
                <h2 className="font-cinzel text-3xl md:text-5xl font-bold text-pizarra leading-tight inline-block relative px-6">
                    {title}
                    <span className="absolute bottom-0 left-1/2 -translate-x-1/2 w-16 h-1 bg-pompeyano rounded mt-2"></span>
                </h2>
            </div>
        );

        // Contenido del Aviso Legal (Completo)
        const LEGAL_CONTENT = `
            <h2 class="font-cinzel text-2xl font-bold text-pompeyano mb-4">1. Datos Identificativos del Titular</h2>
            <p class="mb-3 text-reading">En cumplimiento con la LSSI, se informan los siguientes datos:</p>
            <ul class="list-disc list-inside ml-4 space-y-2">
                <li>Denominación Social: El triunfo de Baco.</li>
                <li>NIF: G 14974489</li>
                <li>Domicilio Social: Carretera de los Arenales, s/n, 14500 Puente Genil (Córdoba)</li>
                <li>Correo electrónico de contacto: ibidemrecreacion@gmail.com</li>
            </ul>

            <h2 class="font-cinzel text-2xl font-bold text-pompeyano mt-8 mb-4">2. Objeto y Uso del Portal</h2>
            <p class="mb-3 text-reading">El acceso a este sitio web atribuye la condición de USUARIO. La finalidad del portal es la divulgación, promoción y recreación de la vida civil romana y la historia.</p>
            <p class="mb-3 text-reading">El USUARIO se compromete a no utilizar el portal ni sus contenidos para actividades ilícitas o contrarias a la buena fe y el orden público.</p>

            <h2 class="font-cinzel text-2xl font-bold text-pompeyano mt-8 mb-4">3. Propiedad Intelectual e Industrial</h2>
            <p class="mb-3 text-reading">Todos los derechos de Propiedad Intelectual e Industrial del sitio web, incluyendo imágenes, textos, logotipos y diseño, son titularidad de Ibidem Recreación Histórica o de terceros que han autorizado su uso.</p>
            <p class="mb-3 text-reading">Queda expresamente prohibida la reproducción, distribución y comunicación pública de los contenidos con fines comerciales, sin la autorización expresa y por escrito de la Asociación.</p>

            <h2 class="font-cinzel text-2xl font-bold text-pompeyano mt-8 mb-4">4. Exclusión de Responsabilidad</h2>
            <p class="mb-3 text-reading">Ibidem Recreación Histórica no se hace responsable de los daños y perjuicios que pudieran ocasionarse por errores, omisiones o la transmisión de virus, a pesar de haber adoptado todas las medidas tecnológicas para evitarlo.</p>
            <p class="mb-3 text-reading">La Asociación no ejerce control sobre los enlaces externos (como redes sociales) y no se responsabiliza de sus contenidos.</p>

            <h2 class="font-cinzel text-2xl font-bold text-pompeyano mt-8 mb-4">5. Legislación Aplicable y Jurisdicción</h2>
            <p class="mb-3 text-reading">La relación entre Ibidem Recreación Histórica y el USUARIO se regirá por la normativa española vigente. Cualquier controversia se someterá a los Juzgados y tribunales de la ciudad de Puente Genil.</p>

            </div>
        `;

        // Contenido de Accesibilidad
        const ACCESIBILITY_CONTENT = `
            <p class="mb-4">Estamos comprometidos a hacer nuestro contenido accesible a todas las personas. Hemos implementado las siguientes medidas:</p>
            <ul class="list-disc list-inside ml-4 text-gray-700 space-y-2">
                <li>Uso de marcado HTML semántico y bien estructurado.</li>
                <li>Contraste de color suficiente para garantizar la legibilidad (Web Content Accessibility Guidelines WCAG 2.1).</li>
                <li>Compatibilidad con navegación por teclado y lectores de pantalla.</li>
                <li>Etiquetas ALT descriptivas para imágenes clave y contenido.</li>
            </ul>
            <p class="mt-6 text-sm italic text-gray-500">Si encuentra alguna barrera de accesibilidad, le agradecemos que nos contacte en ibidemrecreacion@gmail.com.</p>
        `;

        // MODAL PARA AVISO LEGAL Y ACCESIBILIDAD
        const LegalModal = ({ type, onClose }) => {
            const title = type === 'legal' ? 'Aviso Legal' : 'Accesibilidad';
            const contentHTML = type === 'legal' ? LEGAL_CONTENT : ACCESIBILITY_CONTENT;

            return (
                <div className="fixed inset-0 bg-pizarra/70 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-2xl p-6 md:p-10 max-w-lg w-full transform transition-all duration-300 scale-100 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 className="font-cinzel text-2xl font-bold text-pompeyano">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-pizarra p-2 rounded-full hover:bg-gray-100 transition"><Icon path={Icons.X} size={24}/></button>
                        </div>
                        <div className="text-reading text-gray-800" dangerouslySetInnerHTML={{ __html: contentHTML }}></div>
                    </div>
                </div>
            );
        };


        // --- PÁGINAS (Se mantiene la lógica original, salvo PageArticle) ---

        const PageHome = ({ data }) => (
            <div className="fade-in">
                {/* HERO ORIGINAL */}
                <section className="relative h-[50vh] md:h-[60vh] w-full bg-cover bg-center rounded-xl overflow-hidden shadow-xl mb-12 group" style={{ backgroundImage: `url(${data.general.heroImageHome})` }}>
                    <div className="absolute inset-0 bg-gradient-to-t from-pizarra/90 via-transparent to-transparent"></div>
                    <div className="absolute bottom-6 left-6 md:bottom-12 md:left-12 max-w-2xl">
                        <h1 className="font-merriweather text-lg md:text-2xl italic text-pergamino leading-relaxed border-l-4 border-dorado pl-4 shadow-black drop-shadow-md">
                            {data.home.heroTitle}
                        </h1>
                    </div>
                </section>
                
                <section className="max-w-4xl mx-auto text-center mb-16 px-4">
                    <p className="text-lg md:text-xl text-pizarra leading-relaxed text-reading">{data.home.intro}</p>
                </section>
                
                <SectionHeader title="NOSTRA FUNDAMENTA" subtitle="Nuestros Pilares" />
                <div className="grid md:grid-cols-3 gap-8 mb-16 px-4">
                    {data.home.pilares.map((pilar, index) => (
                        <article key={index} className="bg-white p-6 rounded-lg shadow-lg border-t-4 border-dorado hover:-translate-y-2 transition-transform duration-300">
                            <h3 className="font-cinzel text-xl font-bold text-pompeyano mb-3">{pilar.title}</h3>
                            <p className="text-gray-700 mb-4 text-reading">{pilar.text}</p>
                            <a href={`#${pilar.linkTo}`} className="text-dorado-safe font-bold text-xs uppercase tracking-widest hover:text-pompeyano flex items-center gap-1">Saber más <span aria-hidden="true">&rarr;</span></a>
                        </article>
                    ))}
                </div>
            </div>
        );

        const PageNostri = ({ data }) => (
            <div className="fade-in">
                <SectionHeader title="NOSTRI" subtitle="Nuestra Historia" />
                <article className="max-w-4xl mx-auto bg-white p-8 md:p-10 rounded-lg shadow-xl mb-12 border-l-4 border-pompeyano">
                    {data.nostri.mainText.split('\n').map((p, i) => (p.trim() && <p key={i} className="text-lg text-reading leading-relaxed mb-4 text-gray-700">{p}</p>))}
                </article>
                <article className="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-xl flex flex-col md:flex-row gap-8 items-center">
                    <img src={data.nostri.founder.image} alt="Fundador" className="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-dorado object-cover shadow-lg" />
                    <div className="text-center md:text-left">
                        <h4 className="font-cinzel text-2xl font-bold text-pizarra">{data.nostri.founder.name}</h4>
                        <span className="bg-dorado text-white text-xs px-2 py-1 rounded font-cinzel mt-2 inline-block mb-2 tracking-wider">FUNDADOR</span>
                        <p className="text-pompeyano font-cinzel text-sm mb-3 tracking-widest">{data.nostri.founder.years}</p>
                        <p className="text-gray-600 italic text-reading">{data.nostri.founder.desc}</p>
                    </div>
                </article>
            </div>
        );

        const PageFasti = ({ data }) => {
            const enrichedEvents = useMemo(() => {
                const all = [...(data.fasti.upcoming || []), ...(data.fasti.past || [])];
                return all.map(evt => {
                    const album = data.imagina ? data.imagina.find(a => a.id === evt.id) : null;
                    let img = evt.coverImage;
                    if (!img && album) img = album.coverImage || (album.images?.[0]?.src);
                    return { ...evt, displayImage: img };
                });
            }, [data]);

            const { future, groupedPast, years } = useMemo(() => {
                const now = new Date(); now.setHours(0,0,0,0);
                const future = [], past = [];
                enrichedEvents.forEach(e => {
                    const d = parseDate(e.date);
                    if(d >= now) future.push(e); else past.push(e);
                });
                future.sort((a,b) => parseDate(a.date) - parseDate(b.date));
                past.sort((a,b) => parseDate(b.date) - parseDate(a.date));
                const grouped = {};
                past.forEach(e => {
                    const y = parseDate(e.date).getFullYear() || "Antiguo";
                    if(!grouped[y]) grouped[y] = [];
                    grouped[y].push(e);
                });
                return { future, groupedPast: grouped, years: Object.keys(grouped).sort((a,b) => b-a) };
            }, [enrichedEvents]);

            // Carta de Evento Completa (reutilizada)
            const EventCard = ({ event, isFuture }) => (
                <a href={`#imagina?id=${event.id}`} className={`block bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 group h-full flex flex-col ${isFuture ? 'border-t-4 border-pompeyano transform hover:-translate-y-1' : 'border-l-4 border-dorado'}`}>
                    <div className="h-48 overflow-hidden relative bg-gray-100">
                        {event.displayImage ? (
                            <img src={event.displayImage} alt={event.title} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x400/9A2A2A/B8860B?text=IMAGEN+NO+DISPONIBLE"; }}/>
                        ) : (
                            <div className="w-full h-full flex items-center justify-center text-gray-400"><Icon path={Icons.Camera} size={32}/></div>
                        )}
                        <div className="absolute inset-0 bg-pompeyano/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <span className="text-white font-cinzel font-bold tracking-widest text-sm border border-white px-3 py-1 rounded">VER GALERÍA</span>
                        </div>
                    </div>
                    <div className="p-5 flex-grow flex flex-col">
                        <div className="flex items-center gap-2 mb-2">
                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase ${isFuture ? 'bg-pompeyano text-white' : 'bg-gray-200 text-gray-600'}`}>{isFuture ? 'PRÓXIMO' : event.date}</span>
                        </div>
                        <h3 className="font-cinzel text-xl font-bold text-pizarra mb-2 leading-tight group-hover:text-pompeyano transition-colors">{event.title}</h3>
                        <div className="flex items-center text-gray-500 text-sm mb-3">
                            <Icon path={Icons.MapPin} size={14} className="mr-1 text-dorado-safe"/> {event.location.locality}
                        </div>
                        <p className="text-gray-700 text-sm leading-relaxed mb-4 line-clamp-4">{event.desc}</p>
                        <div className="mt-auto flex flex-wrap gap-1">
                            {event.tags && event.tags.slice(0,3).map((t, i) => (
                                <span key={i} className="text-[9px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border border-gray-200 uppercase tracking-wide">{t}</span>
                            ))}
                        </div>
                    </div>
                </a>
            );

            return (
                <div className="fade-in pb-12">
                    <SectionHeader title="FASTI" subtitle="Calendario" />

                    {/* FUTUROS */}
                    {future.length > 0 && (
                        <div className="max-w-6xl mx-auto px-4 mb-20">
                            <h3 className="font-cinzel text-2xl font-bold text-pompeyano mb-8 border-b border-gray-300 pb-2">Proxima Eventa</h3>
                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                                {future.map(e => <EventCard key={e.id} event={e} isFuture={true} />)}
                            </div>
                        </div>
                    )}

                    {/* LÍNEA DE TIEMPO VERTICAL (ACTA PRAETERITA) */}
                    <div className="max-w-5xl mx-auto px-4 relative">
                        <div className="text-center mb-12">
                            <h3 className="font-cinzel text-2xl font-bold text-pizarra inline-block border-b-2 border-dorado pb-1">Acta Praeterita</h3>
                        </div>
                        
                        {/* Línea Central */}
                        <div className="timeline-line"></div>

                        <div className="space-y-16">
                            {years.map(year => (
                                <div key={year} className="relative">
                                    {/* Marcador de Año */}
                                    <div className="flex justify-center mb-8 relative z-10">
                                        <span className="bg-pizarra text-pergamino font-cinzel font-bold text-xl px-4 py-1 rounded shadow-lg border-2 border-dorado">{year}</span>
                                    </div>
                                    
                                    <div className="relative space-y-12">
                                        {groupedPast[year].map((evt, idx) => (
                                            <div key={evt.id} className={`md:flex items-center justify-between w-full ${idx % 2 === 0 ? 'md:flex-row-reverse' : ''}`}>
                                                {/* Espacio vacío para alternancia */}
                                                <div className="hidden md:block md:w-5/12"></div>
                                                
                                                {/* Punto central */}
                                                <div className="absolute left-[20px] md:left-1/2 w-4 h-4 bg-pompeyano border-2 border-white rounded-full shadow transform -translate-x-1/2 z-10 mt-6 md:mt-0"></div>
                                                
                                                {/* Tarjeta */}
                                                <div className="pl-12 md:pl-0 w-full md:w-5/12 relative">
                                                    {/* Flecha decorativa */}
                                                    <div className={`hidden md:block absolute top-1/2 -translate-y-1/2 w-0 h-0 border-y-8 border-y-transparent ${idx % 2 === 0 ? 'right-full border-r-8 border-r-dorado' : 'left-full border-l-8 border-l-dorado'}`}></div>
                                                    <EventCard event={evt} isFuture={false} />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const PageTabularium = ({ data }) => {
            const [filter, setFilter] = useState('TODOS');
            const cats = ['TODOS', ...new Set(data.tabularium.map(a => a.category))];
            const filtered = data.tabularium.filter(a => filter === 'TODOS' || a.category === filter);

            return (
                <div className="fade-in">
                    <SectionHeader title="TABULARIUM" subtitle="Archivo" />
                    <div className="flex justify-center flex-wrap gap-2 mb-10 px-4">
                        {cats.map(c => (
                            <button key={c} onClick={() => setFilter(c)} className={`px-4 py-1 rounded-full font-cinzel text-xs font-bold tracking-wider border transition ${filter===c ? 'bg-pompeyano text-white border-pompeyano' : 'bg-white text-gray-500 border-gray-300 hover:border-pompeyano'}`}>
                                {c.toUpperCase()}
                            </button>
                        ))}
                    </div>
                    <div className="grid md:grid-cols-2 gap-8 max-w-6xl mx-auto px-4">
                        {filtered.map(art => (
                            <article key={art.id} className="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 flex flex-col group">
                                <div className="h-48 overflow-hidden"><img src={art.img} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" alt={art.title} onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x400/2A2A2A/F5EFE3?text=ART%C3%8DCULO+SIN+IMAGEN"; }}/></div>
                                <div className="p-6 flex-col flex flex-grow">
                                    <span className="text-xs font-cinzel text-dorado-safe uppercase tracking-widest mb-2">{art.category}</span>
                                    <h3 className="font-cinzel text-xl font-bold text-pizarra mb-3 leading-tight group-hover:text-pompeyano transition-colors">{art.title}</h3>
                                    <p className="text-gray-600 text-sm mb-4 line-clamp-3 text-reading flex-grow">{art.summary}</p>
                                    <a href={`#article?id=${art.id}`} className="text-pompeyano font-bold text-sm hover:text-dorado-safe flex items-center mt-auto">Leer Artículo <span className="ml-1">&rarr;</span></a>
                                </div>
                            </article>
                        ))}
                    </div>
                </div>
            );
        };

        const PageArticle = ({ id, data }) => {
            const art = data.tabularium.find(a => a.id == id);
            const [markdownContent, setMarkdownContent] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            // Fetch external Markdown file if contentFile exists
            useEffect(() => {
                if (!art) return;
                
                if (art.contentFile) {
                    setIsLoading(true);
                    setMarkdownContent(null);
                    fetch(art.contentFile)
                        .then(res => {
                            if (!res.ok) throw new Error("Archivo no encontrado.");
                            return res.text();
                        })
                        .then(mdText => {
                            setMarkdownContent(mdText);
                        })
                        .catch(e => {
                            console.error("Error fetching article content:", e);
                            setMarkdownContent("Error al cargar el contenido del artículo.");
                        })
                        .finally(() => setIsLoading(false));
                } else {
                     // Fallback for old articles structure (intro/sections)
                    setIsLoading(false);
                }
                window.scrollTo(0, 0);
            }, [id, art]);

            // Simple Markdown to HTML converter (only handles H3 and paragraphs with *italics*)
            const renderMarkdown = (md) => {
                if (!md) return null;
                const lines = md.split('\n');
                let isFirstParagraph = true;
                
                return lines.map((line, index) => {
                    line = line.trim();
                    if (!line) return null; // Skip empty lines
                    
                    if (line.startsWith('###')) {
                        // Title: H3 (used for article sections)
                        isFirstParagraph = false; // Mark that we passed the intro
                        return <h3 key={index} className="font-cinzel text-xl font-bold text-pompeyano mb-3 border-b border-gray-200 pb-1">{line.replace('###', '').trim()}</h3>;
                    }
                    
                    // Paragraphs
                    const isIntro = isFirstParagraph;
                    if(isFirstParagraph) isFirstParagraph = false; // Next paragraph is not the first one.

                    const classes = isIntro ? "text-lg italic border-l-4 border-pompeyano pl-4 mb-8 bg-gray-50 p-4 rounded-r" : "text-reading text-gray-700 leading-relaxed mb-4";
                    // Simple inline *italic* conversion
                    const htmlContent = line.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                    return <p key={index} className={classes} dangerouslySetInnerHTML={{ __html: htmlContent }} />;
                }).filter(Boolean);
            };

            if (!art) return <div>Artículo no encontrado.</div>;

            // --- RENDERIZADO DEL ARTÍCULO ---
            return (
                <article className="max-w-3xl mx-auto bg-white p-8 md:p-12 rounded-xl shadow-2xl my-8 fade-in relative px-6">
                    <a href="#tabularium" className="absolute top-8 left-8 text-gray-400 hover:text-pompeyano transition flex items-center text-sm font-bold"><Icon path={Icons.ArrowLeft} className="mr-1"/> Volver</a>
                    <header className="text-center mb-10 mt-6">
                        <span className="text-xs font-cinzel text-dorado-safe uppercase tracking-widest block mb-2">{art.category}</span>
                        <h1 className="font-cinzel text-3xl md:text-4xl font-bold text-pizarra mb-4">{art.title}</h1>
                        <p className="text-gray-500 italic text-sm">Por {art.author} | {art.date}</p>
                    </header>
                    <img src={art.img} className="w-full rounded-lg mb-10 shadow-md" alt={art.title} onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/700x400/2A2A2A/F5EFE3?text=ART%C3%8DCULO+SIN+IMAGEN+PRINCIPAL"; }}/>
                    
                    {isLoading && art.contentFile && (
                        <div className="text-center py-12">
                            <div className="spinner mx-auto mb-4" style={{width: '30px', height: '30px'}}></div>
                            <p className="font-cinzel text-pompeyano">Cargando Tabulae...</p>
                        </div>
                    )}
                    
                    {/* Renderiza el contenido del archivo MD (nuevo formato) */}
                    {!isLoading && art.contentFile && markdownContent && (
                        <div className="prose max-w-none text-gray-800">
                            {renderMarkdown(markdownContent)}
                        </div>
                    )}

                    {/* Renderiza el contenido interno (antiguo formato) si contentFile NO existe */}
                    {!isLoading && !art.contentFile && art.intro && (
                         <div className="prose max-w-none text-gray-800">
                            <p className="text-lg italic border-l-4 border-pompeyano pl-4 mb-8 bg-gray-50 p-4 rounded-r">{art.intro}</p>
                            {art.sections && art.sections.map((s,i) => (
                                <div key={i} className="mb-8">
                                    <h2 className="font-cinzel text-xl font-bold text-pompeyano mb-3 border-b border-gray-200 pb-1">{s.title}</h2>
                                    <p className="text-reading text-gray-700 leading-relaxed mb-4">{s.content}</p>
                                    {s.image && <img src={s.image} className="w-full rounded shadow-sm my-4" alt="" onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x300/F5EFE3/2A2A2A?text=IMAGEN+SECCI%C3%93N+NO+CARGADA"; }}/>}
                                </div>
                            ))}
                         </div>
                    )}
                    
                    {/* Mensaje de error si no se carga el contenido */}
                    {!isLoading && art.contentFile && !markdownContent && (
                        <p className="text-red-600 text-center">No se pudo cargar el contenido del artículo. Verifique la ruta del archivo.</p>
                    )}
                </article>
            );
        };

        const PageImagina = ({ albumId, data }) => {
            const [selected, setSelected] = useState(null);
            
            // Lógica combinada de álbumes
            const albums = useMemo(() => {
                const combined = [...(data.imagina || [])];
                const events = [...(data.fasti.upcoming||[]), ...(data.fasti.past||[])];
                events.forEach(e => {
                    if (!combined.find(a => a.id === e.id) && (e.images || e.coverImage)) {
                        const imgs = e.images ? [...e.images] : [];
                        if (e.coverImage && (!imgs[0] || imgs[0].src !== e.coverImage)) imgs.unshift({src: e.coverImage});
                        if (imgs.length > 0) combined.push({ id: e.id, eventTitle: e.title, date: e.date, coverImage: e.coverImage || imgs[0].src, images: imgs });
                    }
                });
                return combined.sort((a,b) => parseDate(b.date) - parseDate(a.date));
            }, [data]);

            useEffect(() => {
                if(albumId) setSelected(albums.find(a => a.id == albumId));
                else setSelected(null);
            }, [albumId, albums]);

            if (selected) {
                return (
                    <div className="fade-in px-4">
                        <button onClick={() => window.location.hash = 'imagina'} className="flex items-center text-pompeyano font-bold mb-6 hover:text-dorado-safe"><Icon path={Icons.ArrowLeft} className="mr-2"/> Volver a Galerías</button>
                        <SectionHeader title={selected.eventTitle} subtitle={selected.date} />
                        <div className="columns-1 md:columns-2 lg:columns-3 gap-4 space-y-4">
                            {selected.images.map((img, i) => (
                                <div key={i} className="break-inside-avoid rounded-lg overflow-hidden shadow hover:shadow-lg transition">
                                    <img src={img.src} alt="" className="w-full h-auto" loading="lazy" onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x300/F5EFE3/9A2A2A?text=ERROR+AL+CARGAR"; }}/>
                                    {img.caption && <div className="p-2 bg-white text-xs text-center italic text-gray-600 border-t border-gray-100">{img.caption}</div>}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div className="fade-in px-4">
                    <SectionHeader title="IMAGINA" subtitle="Galería" />
                    <div className="grid md:grid-cols-3 gap-6">
                        {albums.map(alb => (
                            <a key={alb.id} href={`#imagina?id=${alb.id}`} className="block group bg-white rounded-lg overflow-hidden shadow hover:shadow-xl transition-all hover:-translate-y-1">
                                <div className="h-48 overflow-hidden relative">
                                    <img src={alb.coverImage} className="w-full h-full object-cover transition duration-500 group-hover:scale-110" alt={`Portada de ${alb.eventTitle}`} onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x400/9A2A2A/B8860B?text=EVENTO+SIN+IMAGEN"; }}/>
                                    <div className="absolute inset-0 bg-pompeyano/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-white font-cinzel font-bold tracking-widest">VER FOTOS</div>
                                </div>
                                <div className="p-4 text-center">
                                    <h3 className="font-cinzel text-lg font-bold text-pompeyano truncate">{alb.eventTitle}</h3>
                                    <p className="text-xs text-gray-500 mt-1">{alb.date} • {alb.images?.length || 0} Fotos</p>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [data, setData] = useState(null);
            const [page, setPage] = useState('home');
            const [params, setParams] = useState({});
            const [mobileMenu, setMobileMenu] = useState(false);
            const [legalModal, setLegalModal] = useState(null); // 'legal' or 'accesibilidad'

            useEffect(() => {
                // Se usa la ruta relativa del archivo de datos
                fetch('./datos.json').then(r => r.json()).then(d => {
                    setData(d);
                    // Ocultar loader después de cargar los datos
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                });
                
                const handleHash = () => {
                    const hash = window.location.hash.slice(1) || 'home';
                    const [p, q] = hash.split('?');
                    const pars = {};
                    if(q) q.split('&').forEach(pair => {const [k,v]=pair.split('='); pars[k]=v});
                    setPage(p); setParams(pars);
                    setMobileMenu(false);
                    window.scrollTo(0,0);
                };
                window.addEventListener('hashchange', handleHash);
                handleHash();
            }, []);

            if (!data) return null;

            const NavLink = ({ to, label }) => (
                <a href={`#${to}`} className={`font-cinzel font-bold tracking-widest transition-colors ${page === to ? 'text-pompeyano border-b-2 border-pompeyano' : 'text-pizarra hover:text-pompeyano'}`}>{label}</a>
            );

            // MENÚ MÓVIL PANTALLA COMPLETA
            const MobileMenuOverlay = () => (
                <div className={`fixed inset-0 z-50 bg-pompeyano transition-transform duration-500 flex flex-col items-center justify-center space-y-8 ${mobileMenu ? 'translate-x-0' : 'translate-x-full'}`}>
                    <button onClick={() => setMobileMenu(false)} className="absolute top-6 right-6 text-white p-2"><Icon path={Icons.X} size={32}/></button>
                    {/* LOGO CON FILTRO BLANCO */}
                    <img src={data.general.logoUrl} alt="Logo" className="h-20 w-auto mb-8 logo-white opacity-90" />
                    
                    {['home','nostri','fasti','imagina','tabularium'].map(l => (
                        <a key={l} href={`#${l}`} className="text-white font-cinzel text-2xl font-bold tracking-widest hover:text-dorado transition" onClick={() => setMobileMenu(false)}>{l.toUpperCase()}</a>
                    ))}
                    
                    <div className="absolute bottom-10 text-white/50 text-xs font-cinzel tracking-[0.2em]">IBIDEM RECREATIO</div>
                </div>
            );

            return (
                <div className="flex flex-col min-h-screen">
                    <header className="main-header sticky top-0 z-40 border-b border-dorado/20">
                        <div className="container mx-auto px-4 py-3 flex justify-between items-center">
                            {/* LOGO */}
                            <a href="#home"><img src={data.general.logoUrl} alt="Logo" className="h-12 md:h-16 w-auto hover:scale-105 transition"/></a>
                            <nav className="hidden md:flex space-x-8">
                                {['home','nostri','fasti','imagina','tabularium'].map(l => <NavLink key={l} to={l} label={l.toUpperCase()}/>)}
                            </nav>
                            <button className="md:hidden text-pompeyano p-2" onClick={() => setMobileMenu(true)}><Icon path={Icons.Menu} size={28}/></button>
                        </div>
                    </header>

                    <MobileMenuOverlay />

                    <main className="flex-grow container mx-auto py-8 md:py-12 relative z-10 min-h-[60vh]">
                        {page === 'home' && <PageHome data={data} />}
                        {page === 'nostri' && <PageNostri data={data} />}
                        {page === 'fasti' && <PageFasti data={data} />}
                        {page === 'imagina' && <PageImagina data={data} albumId={params.id} />}
                        {page === 'tabularium' && <PageTabularium data={data} />}
                        {page === 'article' && <PageArticle data={data} id={params.id} />}
                    </main>

                    {/* FOOTER */}
                    <footer className="bg-pizarra text-pergamino py-8 border-t-4 border-dorado relative z-20">
                        <div className="container mx-auto px-4 text-center">
                            {/* ICONOS SOCIALES */}
                            <div className="flex justify-center gap-8 mb-6">
                                <a href={data.general.facebook} target="_blank" rel="noopener noreferrer" aria-label="Facebook" className="text-pergamino hover:text-dorado transition transform hover:scale-110 group">
                                    <Icon path={Icons.Facebook} size={30} className="w-8 h-8"/>
                                </a>
                                <a href={data.general.instagram} target="_blank" rel="noopener noreferrer" aria-label="Instagram" className="text-pergamino hover:text-dorado transition transform hover:scale-110 group">
                                    <Icon path={Icons.Instagram} size={30} className="w-8 h-8"/>
                                </a>
                                <a href={`mailto:${data.general.email}`} aria-label="Email de Contacto" className="text-pergamino hover:text-dorado transition transform hover:scale-110 group">
                                    <Icon path={Icons.Mail} size={30} className="w-8 h-8"/>
                                </a>
                            </div>

                            {/* ENLACES LEGALES */}
                            <div className="flex justify-center items-center gap-4 text-xs uppercase tracking-widest font-cinzel text-gray-500 mb-2">
                                <button onClick={() => setLegalModal('legal')} className="hover:text-dorado-safe transition focus:ring-2 focus:ring-dorado-safe rounded px-1">Aviso Legal</button>
                                <span className="text-gray-700">|</span>
                                <button onClick={() => setLegalModal('accesibilidad')} className="hover:text-dorado-safe transition focus:ring-2 focus:ring-dorado-safe rounded px-1">Accesibilidad</button>
                            </div>
                            
                            {/* COPYRIGHT */}
                            <p className="font-cinzel text-xs text-gray-500 tracking-widest mt-4">
                                &copy; {new Date().getFullYear()} IBIDEM.
                            </p>
                        </div>
                    </footer>

                    {/* RENDER MODAL LEGAL */}
                    {legalModal && <LegalModal type={legalModal} onClose={() => setLegalModal(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>